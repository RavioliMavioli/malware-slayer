class_name Bullet extends Sprite2D

@export var post_collision: PackedScene
@export var DAMAGE: int
@export_range(10.0, 2000.0, 1.0) var SPEED: int
@export var LIFETIME:float
@export var collision_shape: CollisionShape2D
@export var notifier: VisibleOnScreenNotifier2D

var timer: Timer = Timer.new()
var already_exploded: bool = true
var query: PhysicsShapeQueryParameters2D = PhysicsShapeQueryParameters2D.new()

func _ready():
	timer.one_shot = true
	timer.autostart = false
	timer.wait_time = LIFETIME
	add_child(timer)
	
	query.set_shape(collision_shape.shape)
	query.collide_with_bodies = true
	query.collide_with_areas = true

	set_collision_mask([1,5])
	
	hide()
	set_physics_process(false)

func _physics_process(delta):
	
	bullet_behaviour(delta)
	query.transform = global_transform
	var results: Array = get_world_2d().direct_space_state.intersect_shape(query, 1)
	for result in results:
		var entity = result["collider"]
		if entity.has_method("hit"):
			entity.hit(global_position, DAMAGE)
		explode()

func _pool_claim():
	if already_exploded:
		timer.timeout.connect(lifetime_timeout)
		notifier.screen_exited.connect(screen_exited)
		notifier.screen_exited.connect(screen_entered)
		already_exploded = false

	timer.start()
	show()
	set_physics_process(true)

func set_collision_mask(num: Array[int]):

	var num_bit: int = 0
	for n in num:
		num_bit += pow(2, n-1) as int # From godot multiple layer collision documentation
	query.collision_mask = num_bit

func bullet_behaviour(delta): # Can be overwritted
	var distance = SPEED*delta
	var motion = transform.x * distance
	position += motion
	
func explode():
	already_exploded = true
	timer.timeout.disconnect(lifetime_timeout)
	notifier.screen_exited.disconnect(screen_exited)
	notifier.screen_exited.disconnect(screen_entered)
	timer.stop()
	
	hide()
	set_physics_process(false)
	var pool := ObjectPool.get_object_pool_from_object(self)
	pool.unclaim(self)
	
	var new_pc = post_collision.instantiate()
	new_pc.global_position = global_position
	get_parent().add_child(new_pc)
	
func lifetime_timeout():
	explode()

func screen_exited():
	hide()

func screen_entered():
	show()
