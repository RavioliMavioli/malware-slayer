class_name NunixCommands extends Resource
# NunixCommands (Not Unix Commands)
# Commands that mimcks unix commands
const MAX_WHILE_ITERATION:int = 50
var parsed_input: PackedStringArray
var output_str: String
var shell: BabuneBash

func _init(_shell: BabuneBash):
	shell = _shell

func process_input(string: String):
	if !string.is_empty():
		var splited_input = string.split(" ", false)
		process_argument(splited_input)
	
func process_argument(_parsed_input: PackedStringArray):
	parsed_input = _parsed_input
	match parsed_input[0]:
		"clear":
			clear()
		"ls":
			ls()
		"cd":
			cd()
		"cat":
			cat()
		"rm":
			rm()
		"neofetch":
			neofetch()
		"ssh":
			ssh()
		"exit":
			exit()
		"quit":
			exit()
		_:
			output_str = parsed_input[0]+':'+" command not found"
			
func clear():
	output_str = ""
func ls():
	clear()
	var get_dir:String = get_directory_from_parameter()
	if get_dir != "":
		var dir = DirAccess.open(get_dir)
		for d in dir.get_directories():
			output_str += d + "/\n"
		for f in dir.get_files():
			output_str += f + "\n"
func cd():
	clear()
	var long_flag: PackedStringArray = ["--help"]
	var flags: PackedStringArray = ["L", "P"]
	flags.append_array(long_flag)
	var dir = DirAccess.open(shell.directories_string[shell.current_env])
	var get_dir:String = get_directory_from_parameter(flags, true)
	if get_dir != "":
		shell.directories_string[shell.current_env] = get_dir
		dir.change_dir(get_dir)
func cat():
	clear()
	var long_flag: PackedStringArray = ["--help"]
	var flags: PackedStringArray = ["n"]
	flags.append_array(long_flag)
	var get_file:String = get_directory_from_parameter(flags)
	if get_file != "" and FileAccess.file_exists(get_file):
		var file = FileAccess.open(get_file, FileAccess.READ)
		output_str = file.get_as_text()
		file.close()
	else:
		var dir = DirAccess.open(shell.directories_string[shell.current_env])
		if dir.dir_exists(get_file):
			output_str = parsed_input[0]+':'+ "'" + parsed_input[parsed_input.size() - 1] + "'" +" is a directory"
			return
		if parsed_input.size() == 1:
			return
		output_str = parsed_input[0]+':'+ "'" + parsed_input[parsed_input.size() - 1] + "'" +" No such file or directory"
		get_directory_from_parameter(flags)
func rm():
	clear()
	var dir = shell.directories_string[shell.current_env]
	var long_flag: PackedStringArray = ["--help"]
	var flags: PackedStringArray = ["r", "f"]
	flags.append_array(long_flag)
	if parsed_input.size() == 1:
		output_str = parsed_input[0]+':'+" file path is empty"
		return
		
	for param in parsed_input:
		if parsed_input.find(param) == 0:
			pass
			
		elif param == "*":
			var dir_a = DirAccess.open(dir)
			for f in dir_a.get_files():
				dir_a.remove(f)
			for d in dir_a.get_directories():
				dir_a.remove(d)
			output_str = parsed_input[0]+':'+" deleted all files"
			
		else:
			var parameter = param
			
			if !FileAccess.file_exists(dir + parameter):
				parameter = "/" + parameter
				if !FileAccess.file_exists(dir + parameter):
					output_str = parsed_input[0]+': ' + '"' + param + '"' +" No such file or directory"
					return
					
			var file = DirAccess.open(dir)
			file.remove(dir + parameter)
			output_str = parsed_input[0]+': ' + '"' + param + '"' +" removed"
func ssh():
	clear()
func get_directory_from_parameter(_flags: PackedStringArray = [], _is_cd: bool = false) -> String:
	var curr_dir: String = shell.directories_string[shell.current_env]
	var dir = DirAccess.open(curr_dir)
	
	if parsed_input.size() == 1:
		if _is_cd:
			output_str = parsed_input[0]+':'+" directory path is empty"
		return curr_dir

	var parameter: String = parsed_input[1]
	# cd defaults to -L flag, which is to handle the operand dot-dot logically
	# The other flag is -P which is physicaly handle the operand
	var i: int = 1
	# Process flags
	if !_flags.is_empty():
		while parameter.begins_with("-") and i <= MAX_WHILE_ITERATION:
			if parameter.begins_with("--"):
				if parameter not in _flags:
					output_str = parsed_input[0]+':'+" invalid option " + parameter
					output_str += "\nTry " + "'" + parsed_input[0] + " --help'" + " for more information."
					return ""
			else:
				for f in parameter:
					if f not in _flags and f != "-":
						output_str = parsed_input[0]+':'+" invalid option " + parameter
						output_str += "\nTry " + "'" + parsed_input[0] + " --help'" + " for more information."
						return ""
					
			i += 1
			if parsed_input.size() <= i:
				print("ASD")
				return ""
			parameter = parsed_input[i]
			
	# Go to root directory
	if parameter.begins_with("/"):
		match shell.current_env:
			0:
				curr_dir = shell.remote_root_dir
			1:
				curr_dir = shell.remote_root_dir
			_:
				curr_dir = shell.root_dir
		# If there is no directory input other than "root", quit
		if parameter.length() == 1:
			#shell.directories_string[shell.current_env] = curr_dir
			return curr_dir
		# Easter Egg
		if parameter == "/root/":
			return "/"
		# else, remove / from the parameter
		parameter = parameter.erase(0, 1)

	if parameter.begins_with(".."):
		var param_splt: PackedStringArray = parameter.rsplit("/", true)
		for p in param_splt:
			if p == "..":
				var dir_splt: PackedStringArray = curr_dir.rsplit("/", true, 1)
				var last_dir: String = dir_splt[dir_splt.size() - 1]
				curr_dir = curr_dir.left(curr_dir.length() - last_dir.length())
				
				if curr_dir[curr_dir.length() - 1] == "/":
					curr_dir = curr_dir.left(curr_dir.length() - 1)
					
				#shell.directories_string[shell.current_env] = curr_dir
		# This is so caveman, fix this with better code
		parameter = parameter.replace("..", "")
		parameter = parameter.replace("//", "/")
	
	if !dir.dir_exists(curr_dir + parameter) or parameter == ".":
		parameter = "/" + parameter
		if !dir.dir_exists(curr_dir + parameter) or parameter == "." or parameter == "/.":
			if FileAccess.file_exists(curr_dir + parameter):
				if _is_cd:
					output_str = parsed_input[0]+':' + "'" + parsed_input[i] + "'" +" is a file"
					return ""
			else:
				if _is_cd:
					output_str = parsed_input[0]+':'+" The directory " + "'"+ parsed_input[i] + "'" +" does not exist"
				return ""

	return curr_dir + parameter
func neofetch():
	var arch: String =("
	   /\\		arch@chan
	  /  \\		OS:			Arch-Linux
	 /\\   \\		Host:		Q25
	/      \\	Kernel:		7.0.0
   /   ,,   \\	Packages: 	203
  /   |  |  -\\	CPU: 		IBM Q 53
 /_-''    ''-_\\	
	")
	output_str = arch
func exit():
	clear()
	shell.terminal.close()
	Timemode.current_time_mode = Timemode._time_mode.NORMAL
