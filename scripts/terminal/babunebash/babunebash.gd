class_name BabuneBash extends Resource
# BabuneBash (Bash but not exactly bash shell)
# A script that mimicks bash shell language and UNIX commands

var nunix: NunixCommands = NunixCommands.new(self)
var terminal: Control
var tty_in: RichTextLabel
var tty_out: RichTextLabel

var button_group: ButtonGroup
var env_string_contents: PackedStringArray
var root_dir: String
var remote_root_dir: String
var directories_string: PackedStringArray
var current_env: int = 0

func _init(_terminal: Control, _button_group: ButtonGroup):
	terminal = _terminal
	tty_in = terminal.tty_input
	tty_out = terminal.tty_output
	button_group = _button_group
	# TODO: Change this below so when reloading the game the history remains presist
	env_string_contents.resize(button_group.get_buttons().size())
	env_string_contents.fill("")
	init_dir()
	
func input(event: InputEvent):
	# Main function call
	if event is InputEventKey and event.is_pressed():
		parse_input(event)
		
	if event.is_action_pressed("Enter"):
		nunix.process_input(tty_in.text)
		set_output(nunix.output_str)
		tty_in.text = " "
	
func parse_input(event: InputEvent):
	# TODO: Replace this with CodeEdit node
	# For now, I dont' know how to use CodeEdit node
	var typed_event: InputEventKey = event as InputEventKey
	var key_typed = PackedByteArray([typed_event.unicode]).get_string_from_utf8()
	
	if typed_event.as_text_key_label() == "Backspace" and tty_in.text.length() >= 1:
		tty_in.text = tty_in.text.erase(tty_in.text.length() - 1)
		
	if !typed_event.as_text_key_label().contains("Ctrl"):
		tty_in.text += key_typed

func set_output(string: String):
	env_string_contents.set(current_env, string)

func update():
	update_current_env()
	update_output()
	update_buttons_name()
	
func update_current_env():
	# Set environment to the current selected one
	current_env = button_group.get_buttons().find(button_group.get_pressed_button())
	
func update_output():
	tty_out.text = env_string_contents[current_env]

func update_buttons_name():
	# TODO: This mfs is updated every frame thus being power hungry. fix it
	var ar: Array[BaseButton] = button_group.get_buttons()
	for i in len(ar):
		var s: PackedStringArray = directories_string[i].split("/", true, 4)
		var new_s: String = s[s.size() - 1].replace("root","").replace("remote", "")
		if new_s.begins_with(""):
			new_s = "/" + new_s
		ar[i].text = new_s
			
func init_dir():
	var dir: PackedStringArray = [""]
	dir.resize(6)
	dir[0] = "res://venv/remote"
	dir[1] = "res://venv/remote"
	
	dir[2] = "res://venv/root"
	dir[3] = "res://venv/root/bin"
	dir[4] = "res://venv/root/mnt"
	dir[5] = "res://venv/root/sys"
	
	directories_string = dir
	
	root_dir = "res://venv/root"
	remote_root_dir = "res://venv/remote"
