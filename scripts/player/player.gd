class_name PlayerClass extends CharacterBody2D

@export_category("Selected Character")
@export var characters: Player._character = Player._character.ARCH

@export_category("Character Scenes")
@export var arch_chan: PackedScene
@export var void_chan: PackedScene
@export var ubuntu_chan: PackedScene
@export var debian_chan: PackedScene
@export var gentoo_chan: PackedScene
@export var sync_chan: PackedScene
@export var steamos_chan: PackedScene

const RUNNING_SPEED: float = 300
const JUMP_VELOCITY: float = 300
const DOUBLE_JUMP_VELOCITY: float = 400
const TERMINAL_VELOCITY: float = 850.0
const LEDGE_VELOCITY_TOLERANCE: float = 300
const JUMP_DURATION_WAIT_TIME: float = 0.3
const COYOTE_JUMP_WAIT_TIME: float = 0.066
const LEDGE_STOP_VELOCITY_TOLERANCE: float = 50.0

var SPEED_devider = 4
var gravity = Gravity.gravity
var direction: int = 0
var delta_cursor_position: Vector2 = Vector2.ZERO

var was_on_floor: bool = false
var can_double_jump: bool = false
var can_coyote_jump: bool = false
var can_ledge: bool = false
var area_ledge_L: Array
var area_ledge_R: Array

@onready var state_manager: StateManager = StateManager.new(self)
@onready var animation_manager: AnimationManager = AnimationManager.new(self)

@onready var ledge_detection_R: Area2D = $LedgeDetectionR
@onready var ledge_detection_L: Area2D = $LedgeDetectionL
@onready var platform_check: Area2D = $PlatformCheck
@onready var ground_clearance: Area2D = $GroundClearance
@onready var aim_center: Marker2D = $AimCenter
@onready var bullet_spawn: Marker2D = $AimCenter/BulletSpawn

var character_array: Array[PackedScene]
var character_node: Node2D
var sprite_node: AnimatedSprite2D
var animation_tree: AnimationTree
var jump_duration: Timer = Timer.new()
var coyote_jump_timer: Timer = Timer.new()

#################### _ready ########################

func _ready():
	setup_timer()
	setup_character()
	animation_manager.setup_animation_tree(animation_tree)

#################### _input ########################

func _input(event):
	input(event)
		
#################### _physics_process ########################

func _physics_process(delta):
	match Player.enable_input:
		Player._enable_input.ENABLED:
			player_controls()
			
		Player._enable_input.DISABLED:
			direction = 0
	match state_manager.current_state:
		state_manager._state.DED:
			pass
		_:
			player_physics(delta)
	
#################### _process ########################

func _process(_delta):
	
	state_manager.process()
	animation_manager.process()
	
	$Label/CharState.text = state_manager.get_current_state_id()
	$Label/CharFacing.text = state_manager.get_current_facing_id()
	$Label/CharHead.text = state_manager.get_current_head_id()
	$Label/CharFlip.text = state_manager.get_current_flip_id()
	$Label/CharFire.text = state_manager.get_current_fire_id()

#######################################################

func setup_timer():
	# Jump timer
	jump_duration.one_shot = true
	jump_duration.wait_time = JUMP_DURATION_WAIT_TIME
	add_child(jump_duration)
	# Coyote jump timer
	coyote_jump_timer.one_shot = true
	coyote_jump_timer.wait_time = COYOTE_JUMP_WAIT_TIME
	add_child(coyote_jump_timer)
	coyote_jump_timer.timeout.connect(_on_coyote_jump_timeout)

func setup_character():
	# Please change this whenever new character is added or changed and recheck the order
	character_array = [arch_chan,void_chan,ubuntu_chan,debian_chan,gentoo_chan,sync_chan,steamos_chan]
	Player.current_character = characters
	# Set the character to the chosen character
	character_node = character_array[Player.current_character].instantiate() as Node2D

	sprite_node = character_node.get_node("AnimatedSprite2D")
	animation_tree = character_node.get_node("AnimationTree")
	add_child(character_node)

func input(event: InputEvent):
	# Pause the game
	if event.is_action_pressed("Pause"):
		pass

func player_controls():
	
	#################### Movement Control ########################
	
	direction = Input.get_axis("A", "D") as int
	
	#################### Ledge Control ########################
	

	
	if 	Input.is_action_pressed("S"):
		can_ledge = false
		
	if Input.is_action_just_pressed("Space") and (!area_ledge_L.is_empty() or !area_ledge_R.is_empty()) and is_ledge_stop_velocity_tolerance():
		# Idk man, being on ledge somewhow is not Vector2.ZERO, it still has vertical velocity -24.5 but no horizontal velocity
		jump_duration.start()
		can_double_jump = true
		can_ledge = false
	
	#################### Jump Control ########################
	
	if Input.is_action_pressed("Space") and (is_on_floor() or can_coyote_jump):
		# Jump as long as the jump timer still going
		jump_duration.start()
		can_coyote_jump = false
	if Input.is_action_just_released("Space"):
		# No jump timer, jump stopped
		jump_duration.stop()
		
	#################### Double Jump Control ########################
	
	if (	Input.is_action_just_pressed("Space")					and
			coyote_jump_timer.is_stopped() 							and
			!is_on_floor() and can_double_jump						and
			!ground_clearance.has_overlapping_bodies() 				and
			
			(	(	!ledge_detection_L.has_overlapping_areas() 		and
					!ledge_detection_R.has_overlapping_areas()	)	or
					!is_ledge_stop_velocity_tolerance()			)	):
		
		double_jump()
		can_double_jump = false
		
	#################### Platform Control ########################
	
	if Input.is_action_pressed("S") and platform_check.has_overlapping_bodies():
		global_position.y += 1
	
	#################### Shooting Mechanic ########################
	
	if Input.is_action_pressed("L Shoot"):
		shoot_lmb()

	if Input.is_action_pressed("R Shoot"):
		shoot_rmb()
		
	#################### Specials ########################
	
	if Input.is_action_just_pressed("E"):
		special_e()
	
	if Input.is_action_just_pressed("Q"):
		special_q()

func player_physics(delta):
		
	area_ledge_L = ledge_detection_L.get_overlapping_areas()
	area_ledge_R = ledge_detection_R.get_overlapping_areas()
	# Cursor position from the player
	delta_cursor_position = get_global_mouse_position() - global_position
	# Get input direction, results -1, 0, 1
	#################### Terminal Velocity ####################
	
	velocity = Vector2(	min(abs(velocity.x), TERMINAL_VELOCITY) * sign(velocity.x) ,
						min(abs(velocity.y), TERMINAL_VELOCITY) * sign(velocity.y) )
	
	#################### Ledge Mechanic ####################
	
	if can_ledge and velocity.y >= -LEDGE_VELOCITY_TOLERANCE:
		if !area_ledge_L.is_empty() and "R" in area_ledge_L.front().name:
			velocity = Vector2.ZERO
			global_position = lerp(global_position, area_ledge_L.front().global_position - ledge_detection_L.position, 0.5)
			
		elif !area_ledge_R.is_empty() and "L" in area_ledge_R.front().name:
			velocity = Vector2.ZERO
			global_position = lerp(global_position, area_ledge_R.front().global_position - ledge_detection_R.position, 0.5)

	if area_ledge_L.is_empty() and area_ledge_R.is_empty():
		can_ledge = true

	#################### Falling ####################
	
	if !is_on_floor():
		velocity.y += gravity * delta
		
	#################### Coyote Jump ####################

	if is_on_floor():
		can_coyote_jump = true
	# Compare the current frame and previous frame if the character just left the floor
	elif was_on_floor: 
		coyote_jump_timer.start()
		
	#################### Jump ####################	
	# Jump based on the duration of the spacebar when it is pressed, called every process
	jump(jump_duration)
	
	#################### Double Jump ####################
	
	if is_on_floor():
		can_double_jump = true
	
	#################### Movement ########################
	# If player on the ground, the move speed is normal
		SPEED_devider = 4
	else:
		# If player on the air, the move speed is slower
		SPEED_devider = 16
	# Fast acceleration but slow deceleration
	velocity.x = move_toward(	velocity.x,
								direction * RUNNING_SPEED,
								RUNNING_SPEED/(SPEED_devider if direction else SPEED_devider * 2)	)
	
	#################### move_and_slide ########################
	was_on_floor = is_on_floor()
	
	print("")		## GLOBAL FUNCTION
	move_and_slide()	## ENGINE FUNCTION (from CharacterBody2D)
	my_function()		## USER FUNCTION
	
#################### Jump Function ########################

func my_function():
	pass
func jump(jump_dur: Timer):
	var time_left = jump_dur.time_left
	if !jump_dur.is_stopped():
		velocity.y = -JUMP_VELOCITY - (time_left/jump_duration.wait_time*100)
	
func double_jump():
	velocity.y = -DOUBLE_JUMP_VELOCITY

#################### Etc ########################

func is_ledge_stop_velocity_tolerance():
	return (abs(velocity.x) <= LEDGE_STOP_VELOCITY_TOLERANCE and abs(velocity.y) <= LEDGE_STOP_VELOCITY_TOLERANCE)

#################### Specials ########################

func shoot_lmb():
	pass
	
func shoot_rmb():
	pass

func special_e():
	pass
	
func special_q():
	pass
		
#################### Etc ########################

func _on_coyote_jump_timeout():
	can_coyote_jump = false
