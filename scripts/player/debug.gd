extends Control

@onready var debug_box: CheckBox = $Debug
@onready var container: Control = $Container
@onready var timeslider: HSlider = $Container/VBoxContainer/Timescale/HSlider
@onready var timescheck: CheckBox = $Container/VBoxContainer/Timescale/OptionButton
@onready var timelabel: Label = $Container/VBoxContainer/Timescale/Label
@onready var floating_node: Control = get_owner().get_node("FloatingText")

@onready var terminal_anim: Control = get_owner().get_node("PlayerFloatingText").get_node("Terminal")
@onready var pause_physics: CheckBox = $Container/VBoxContainer/Pause
@onready var player_menu_box: CheckBox = $Container/VBoxContainer/PlayerMenu
@onready var zoom_box: CheckBox = $Container/VBoxContainer/Zoom
@onready var free_look_box: CheckBox = $Container/VBoxContainer/FreeLook
@onready var player_state_box: CheckBox = $Container/VBoxContainer/PlayerState
@onready var hide_floating_box: CheckBox = $Container/VBoxContainer/HideFloating

var mouse_is_inside = false
var init_pos
var cam_pos

func _ready():
	init_pos = container.global_position
	mouse_entered.connect(_mouse_entered)
	mouse_exited.connect(_mouse_exited)
	pause_physics.pressed.connect(pause)
	zoom_box.pressed.connect(zoom)
	player_menu_box.pressed.connect(playermenu)
	hide_floating_box.pressed.connect(floating)

func _input(event):
	freelook_input(event)
	# TODO: fix all this inputs tomfoolery
	if event.is_action_pressed("T") and Timemode.current_time_mode == Timemode._time_mode.NORMAL and !Player.player_node.is_on_floor():
		zoom_box.button_pressed = true
		player_menu_box.button_pressed = true
	if event.is_action_pressed("Pause") and Timemode.current_time_mode == Timemode._time_mode.SLOWMO:
		player_menu_box.button_pressed = false
		zoom_box.button_pressed = false

func _process(delta):
	if debug_box.button_pressed:
		container.global_position = lerp(container.global_position, init_pos, delta * (1/Engine.time_scale) * 10)
		Player.enable_input = Player._enable_input.ENABLED
		time()
		# playermenu() is signal
		# zoom() signal
		# hd() signal
		# freelook_input() _input
		freelook_physics(delta)
		playerstate()

	else:
		container.global_position = lerp(container.global_position, container.global_position + Vector2(CAV.container_default_size.x - container.global_position.x,0), delta * (1/Engine.time_scale) * 10)

func time():
	timelabel.text = str(timeslider.value)
	if timescheck.button_pressed:
		Engine.time_scale = timeslider.value

func pause():
	get_tree().paused = pause_physics.button_pressed

func playermenu():
	if player_menu_box.button_pressed:
		terminal_anim.open()
		Cursor.current_cursor_state = Cursor._cursor_state.NORMAL
	else:
		terminal_anim.close()
		if !mouse_is_inside:
			Cursor.current_cursor_state = Cursor._cursor_state.AIM

func zoom():
	if zoom_box.button_pressed:
		CAV.current_zoom_type = CAV._zoom_type.ZOOMED
	else:
		CAV.current_zoom_type = CAV._zoom_type.NORMAL
		
func playerstate():
	Player.player_node.get_node("State").visible = player_state_box.button_pressed

func freelook_input(event: InputEvent):
	var d_mouse = CAV.container_default_size/2 - get_global_mouse_position()
	if free_look_box.button_pressed:
		if event is InputEventMouseMotion and (Input.is_action_pressed("L Shoot") or Input.is_action_pressed("Middle Mouse")):
			CAV.camera_node.global_position -= event.relative / 2 / CAV.camera_node.zoom
		if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_WHEEL_UP:
			CAV.camera_node.zoom += Vector2(0.05, 0.05) * CAV.camera_node.zoom
			CAV.camera_node.global_position -= d_mouse / CAV.camera_node.zoom / 20.0
		if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_WHEEL_DOWN:
			CAV.camera_node.zoom -= Vector2(0.05, 0.05) * CAV.camera_node.zoom
			CAV.camera_node.global_position += d_mouse / CAV.camera_node.zoom / 20.0

func freelook_physics(delta):
	CAV.camera_node.set_physics_process(!free_look_box.button_pressed)
	if !free_look_box.button_pressed:
		CAV.camera_node.zoom = lerp (CAV.camera_node.zoom, Vector2.ONE, delta * 10 * (1/Engine.time_scale))

func floating():
	floating_node.visible = !hide_floating_box.button_pressed

func _mouse_entered():
	if debug_box.button_pressed:
		Cursor.current_cursor_state = Cursor._cursor_state.NORMAL
		mouse_is_inside = true
		
func _mouse_exited():
	if !player_menu_box.button_pressed:
		Cursor.current_cursor_state = Cursor._cursor_state.AIM
		mouse_is_inside = false

