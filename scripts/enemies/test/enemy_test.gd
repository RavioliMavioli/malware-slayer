class_name Enemy extends RigidBody2D

const SPEED = 5000
const JUMP = -500

var sprite:AnimatedSprite2D:
	get: return $Sprite
var collider:CollisionShape2D:
	get: return$Collision
var health:HealthComponent:
	get: return %HealthComponent

var cam_shake:= VFX.camera_shake.new()

var delta_player_position: Vector2

func _ready():
	sprite.visible = true
	health.died.connect(_died)

func _physics_process(delta):

	modulate = lerp(modulate, Color(1.0, 1.0, 1.0), delta*8)
	global_position = global_position
	global_rotation = 0.0
	enemy_behaviour(delta)

func enemy_behaviour(delta):
	delta_player_position = Player.player_node.global_position - global_position
	sprite.play("idle")

	var direction:float = delta_player_position.x
	if direction < 0:
		direction = -1
	else:
		direction = 1

	linear_velocity.x = direction * SPEED * delta

	if delta_player_position.x < 0:
		$Sprite.flip_h = true
	else:
		$Sprite.flip_h = false

func _died():
	EntityManager.mark_as_unsaveable(self)
	modulate = Color(1,1,1)
	$AnimationPlayer.play("dead")
	set_physics_process(false)
	freeze = true
	sprite.visible = false
	$Dead.start()
	$Blood.emitting = true
	collider.disabled = true
	cam_shake.shake_long_strong()
	VFX.shockwave.spawn_weak(self)

func _on_animation_player_animation_finished(_anim_name):
	queue_free()

func _on_dead_timeout():
	queue_free()
