class_name Enemy extends RigidBody2D

@export var health_component: HealthComponent
@onready var health_bar:TextureProgressBar = $Control/ControlHealthBar/HealthBar
@onready var sprite:AnimatedSprite2D = $Sprite
@onready var collider:CollisionShape2D = $Collision

var enemy_folder_str: String = "res://venv/root/mnt/"
var i: int
const SPEED = 5000
const JUMP = -500
var file_created: bool = false
var dir = DirAccess.open("res://venv/root/mnt/")
var delta_player_position: Vector2

func _ready():
	sprite.visible = true

func _notification(what):
	if what == NOTIFICATION_WM_CLOSE_REQUEST:
		var dir = DirAccess.open("res://venv/root/mnt/")
		dir.remove(enemy_folder_str)

func _physics_process(delta):
	
	if !file_created:
		enemy_folder_str += "enemy_" + str(i)
		var enemy_file: FileAccess = FileAccess.open(enemy_folder_str,FileAccess.WRITE)
		enemy_file.store_string("enemy")
		enemy_file.close()
		file_created = true
	
	modulate = lerp(modulate, Color(1.0, 1.0, 1.0), delta*8)
	global_position = global_position
	global_rotation = 0.0
	enemy_behaviour(delta)

func _process(_delta):
	if !dir.file_exists(enemy_folder_str):
		dead()

func enemy_behaviour(delta):
	delta_player_position = Player.player_global_position - global_position
	sprite.play("idle")
	
	var direction:float = delta_player_position.x
	if direction < 0:
		direction = -1
	else:
		direction = 1
		
	linear_velocity.x = direction * SPEED * delta
	
	if delta_player_position.x < 0:
		$Sprite.flip_h = true
	else:
		$Sprite.flip_h = false
	
	health_bar.value = health_component.health
	
func dead():
	
	var dir = DirAccess.open("res://venv/root/mnt/")
	dir.remove(enemy_folder_str)
	
	health_bar.visible = false
	$AnimationPlayer.play("dead")
	set_physics_process(false)
	freeze = true
	sprite.visible = false
	$Dead.start()
	$Blood.emitting = true
	collider.disabled = true
	EntityPooler.enemy_pool.erase(self)

func _on_dead_timeout():
	queue_free()
