class_name CameraShaker extends Resource

var camera_node: Camera2D:
	get: return await CAV.get_camera_node()

var shake_factor:float = 10.0
var shake_duration:float = 0.1
var shake_per_sec:float = 0.01

var duration: Timer
var physics: Timer
	
func screen_shake(factor:float, time_duration:float):
	if duration == null or physics == null:
		duration = Timer.new()
		physics = Timer.new()
		duration.timeout.connect(_duration_timeout)
		physics.timeout.connect(_physics_timeout)
		
		camera_node.add_child(duration)
		camera_node.add_child(physics)
	
	shake_factor = factor
	shake_duration = time_duration
	
	duration.wait_time = shake_duration
	duration.one_shot = true
	duration.autostart = false
	
	physics.wait_time = shake_per_sec
	physics.one_shot = false
	physics.autostart = false
	
	duration.start()
	physics.start()

func _shake():
	var shake_duration_normalized = duration.time_left/shake_duration
	var rng = Vector2(	randf_range(-shake_factor*shake_duration_normalized,shake_factor*shake_duration_normalized)	,
						randf_range(-shake_factor*shake_duration_normalized,shake_factor*shake_duration_normalized)	)
	camera_node.position += rng

func _duration_timeout():
	duration.queue_free()
	physics.queue_free()
	
func _physics_timeout():
	_shake()
