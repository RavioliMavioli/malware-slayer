class_name Dropable extends RigidBody2D

@export var lifetime: float = 6.0

const FADING_TIME := 1.5
const DELAY := 0.15
var player: PlayerInstance = await Player.get_player_node()
var light: Light2D:
	get: return $Light
var detector: Area2D:
	get: return $Detector
var sfx: SFXPlayer:
	get: return $SFXPlayer
var trail: TrailSpawner:
	get: return $TrailSpawner
var picking = false
var lifetime_timer: SceneTreeTimer
var tween: Tween
var pool: ObjectPool

func picked() -> void:
	hide()
	trail.destroy()
	sfx.play()
	await sfx.finished
	_unclaim()

func _ready() -> void:
	hide()
	set_physics_process(false)
	freeze = true

func _physics_process(delta):
	if !picking:
		return
	if tween != null:
		tween.kill()
	freeze = true
	modulate.a = 1.0
	global_position = lerp(global_position, player.global_position, delta*10)
	if global_position.distance_to(player.global_position) < 30:
		set_physics_process(false)
		picked()

func _setup_detector() -> void:
	detector.body_entered.connect(_detector_body_entered)
	
func _delay() -> void:
	detector.monitoring = false
	await get_tree().create_timer(DELAY).timeout
	detector.monitoring = true

func _create_timer() -> void:
	lifetime_timer = get_tree().create_timer(lifetime - FADING_TIME)
	lifetime_timer.timeout.connect(_lifetime_timer_timeout)
	
func _spawn_trail() -> void:
	trail.destroy_instantly()
	trail.spawn(self)
	light.color = trail.color

func _pool_claim():
	_setup_detector()
	_delay()
	_create_timer()
	_spawn_trail()
	show()
	set_physics_process(true)
	freeze = false
	modulate.a = 1.0

func _pool_unclaim():
	detector.body_entered.disconnect(_detector_body_entered)
	lifetime_timer.timeout.disconnect(_lifetime_timer_timeout)
	hide()
	set_physics_process(false)
	freeze = true
	picking = false

func _unclaim() -> void:
	var _pool = ObjectPoolService.get_pool_from_object(self)
	if _pool != null and _pool.is_claimed(self):
		ObjectPoolService.unclaim(self)

func _lifetime_timer_timeout() -> void:
	_fade_out()

func _fade_out() -> void:
	tween = get_tree().create_tween()
	tween.tween_property(self, "modulate", Color.TRANSPARENT, FADING_TIME)
	await tween.finished
	_unclaim()

func _detector_body_entered(body: Node2D) -> void:
	picking = true
