class_name Dialogue extends Control

signal finished(normal_exit)

var speed_multiplier: float = 2

var json_reader: DialogueJSONReader:
	get: return %JSONReader
var rich_text: RichTextLabel:
	get: return %Text
var conditions: Array:
	get: return json_reader.conditions
var anim: AnimationPlayer:
	get: return $AnimationPlayer
var is_open := false

func json_read(json: JSON):
	json_reader.read(json)

func start(ids: Array[int]) -> void:
	if is_open:
		return
	anim.play("open")
	json_reader.start(ids)
	is_open = true

func exit(is_normal: bool = true) -> void:
	if !is_open:
		return
	anim.play("close")
	json_reader.exit()
	finished.emit(is_normal)
	is_open = false

func get_ids_from_conditions(_conditions: Array[Dictionary]) -> Array[int]:
	var id_arr: Array[int] = []
	for id in json_reader.dict_ids:
		for cond in id["conditions"]:
			for _cond in _conditions:
				if !cond.has(_cond.keys()[0]):
					continue # to the next loop
				if cond.get(cond.keys()[0]) == _cond.get(_cond.keys()[0]):
					var i := json_reader.dict_ids.find(id)
					if !id_arr.has(i):
						id_arr.append(i)
	return id_arr

func _ready() -> void:
	hide()
	anim.play("close")
	json_reader.dialogue_finished.connect(_dialogue_finished)

func _dialogue_finished() -> void:
	exit()
