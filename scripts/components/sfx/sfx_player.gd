class_name SFXPlayer extends Node2D

signal finished

@export var sfx_array: Array[AudioStream]
@export var autoplay: bool = false
@export var shuffle: bool = true
@export var delay: float = 0.0
@export_range(0.0, 1.0, 0.01) var random_pitch: float = 0.0
@export var max_polyphony: int = 5
@export var volume: float = 0.0
@export_range(0.1, 2.0, 0.01) var pitch: float = 1.0
@export var panning_strength: float = 1.0
@export var audio_bus: Audio.AUDIO_BUS =  Audio.AUDIO_BUS.SFX

var audio_streams: Array[AudioStreamPlayer2D]
var index := 0

func play() -> void:
	if sfx_array.size() == 0:
		return
	if shuffle:
		index = randi_range(0, sfx_array.size() - 1)
	else:
		index = wrapi(index + 1, 0, sfx_array.size())
	if random_pitch:
		var new_pitch = audio_streams[index].pitch_scale + randf_range(-random_pitch, random_pitch)
		audio_streams[index].pitch_scale = new_pitch
	await get_tree().create_timer(delay).timeout
	audio_streams[index].play()

func stop() -> void:
	for stream in audio_streams:
		stream.stop()
	finished.emit()

func destroy() -> void:
	for stream in audio_streams:
		stream.queue_free()

func fade_in(duration: float) -> void:
	var stream = audio_streams[index]
	stream.volume_db = -50.0
	var tween: Tween = get_tree().create_tween()
	tween.set_ease(Tween.EASE_OUT)
	tween.set_trans(Tween.TRANS_QUAD)
	tween.tween_property(stream, "volume_db", volume, duration)

func fade_out(duration: float) -> void:
	var stream = audio_streams[index]
	var tween: Tween = get_tree().create_tween()
	tween.set_ease(Tween.EASE_IN)
	tween.set_trans(Tween.TRANS_QUART)
	await tween.tween_property(stream, "volume_db", -50.0, duration).finished
	stop()

func is_still_playing() -> bool:
	for stream in audio_streams:
		if stream.playing:
			return true
	return false

func _ready() -> void:
	_spawn_sfx_node()
	if autoplay:
		play()

func _physics_process(delta: float) -> void:
	if audio_bus != Audio.AUDIO_BUS.SFX:
		return
	for audio in audio_streams:
		if Timemode.current_time_mode == Timemode.TIME_MODE.SLOWMO:
			audio.pitch_scale = Engine.time_scale
		else:
			audio.pitch_scale = lerp(audio.pitch_scale, Engine.time_scale, delta * 10 * 1/Engine.time_scale )

func _spawn_sfx_node() -> void:
	for sound in sfx_array:
		var sfx_node := AudioStreamPlayer2D.new()
		var audio_bus_str := Audio.get_bus_str(audio_bus)
		sfx_node.bus = audio_bus_str
		sfx_node.stream = sound
		sfx_node.volume_db = volume
		sfx_node.max_polyphony = max_polyphony
		sfx_node.pitch_scale = pitch
		sfx_node.panning_strength = panning_strength
		sfx_node.finished.connect(_finished)
		audio_streams.append(sfx_node)
		if audio_bus == Audio.AUDIO_BUS.BGM:
			CAV.camera_node.add_child(sfx_node)
		else:
			add_child(sfx_node)

func _finished() -> void:
	finished.emit()
