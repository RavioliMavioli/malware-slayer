extends Control

var player_node: PlayerInstance = await Player.get_player_node()
var terminal: Terminal:
	get: return Terminal.instance
var debug_box: Button:
	get: return $Debug
var container: Control:
	get: return $Container
var timeslider: HSlider:
	get: return $Container/VBoxContainer/Timescale/HSlider
var timescheck: CheckBox:
	get: return $Container/VBoxContainer/Timescale/OptionButton
var timelabel: Label:
	get: return $Container/VBoxContainer/Timescale/Label
var floating_node: CanvasLayer:
	get: return Game.instance.get_node("%FloatingUI")
var pause_physics: CheckBox:
	get: return $Container/VBoxContainer/Pause
var terminal_box: CheckBox:
	get: return $Container/VBoxContainer/ShowTerminal
var free_look_box: CheckBox:
	get: return $Container/VBoxContainer/FreeLook
var player_state_box: CheckBox:
	get: return $Container/VBoxContainer/PlayerState
var hide_floating_box: CheckBox:
	get: return $Container/VBoxContainer/HideFloating
var enable_particles_box: CheckBox:
	get: return $Container/VBoxContainer/EnableParticles
var enable_shaders_box: CheckBox:
	get: return $Container/VBoxContainer/EnableShaders

var init_pos
var cam_pos

func _ready():
	init_pos = container.global_position
	debug_box.pressed.connect(_debug)
	pause_physics.pressed.connect(_pause)
	terminal_box.pressed.connect(_terminal)
	free_look_box.pressed.connect(_freelook)
	player_state_box.pressed.connect(_playerstate)
	hide_floating_box.pressed.connect(_floating)
	enable_particles_box.pressed.connect(_particles)
	enable_shaders_box.pressed.connect(_shaders)
	
	enable_particles_box.button_pressed = Levels.vfx_particle_node.visible
	enable_shaders_box.button_pressed = Levels.vfx_shader_node.visible

func _input(event):
	_freelook_input(event)

func _process(delta):
	terminal_box.button_pressed = true if Terminal.current_status == Terminal.STATUS.OPEN else false
	if debug_box.button_pressed:
		container.global_position = lerp(container.global_position, init_pos, delta * (1/Engine.time_scale) * 10)
		_time()
		_unlimited_terminal_power()
	else:
		container.global_position = lerp(container.global_position, container.global_position + Vector2(get_viewport().size.x - container.global_position.x,0), delta * (1/Engine.time_scale) * 10)

func _time():
	timelabel.text = str(timeslider.value)
	if timescheck.button_pressed:
		Engine.time_scale = timeslider.value
		Timemode.engine_time = timeslider.value
		Audio.sfx_low_pass_effect.cutoff_hz = Engine.time_scale * 20500.0
	else:
		Timemode.reset_time_mode()

func _unlimited_terminal_power():
	if terminal_box.button_pressed:
		terminal.instance.processing_power = 100.0

func _debug():
	pass
	
func _pause():
	get_tree().paused = pause_physics.button_pressed

func _terminal():
	if terminal_box.button_pressed:
		terminal.open()
	else:
		terminal.close()

func _freelook():
	CAV.camera_node.set_physics_process(!free_look_box.button_pressed)

func _playerstate():
	player_node.get_node("%State").visible = player_state_box.button_pressed

func _freelook_input(event: InputEvent):
	var d_mouse = get_global_mouse_position()
	if free_look_box.button_pressed:
		if event is InputEventMouseMotion and (Input.is_action_pressed("Shoot_1")):
			CAV.camera_node.global_position -= event.relative / CAV.camera_node.zoom
		if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_WHEEL_UP:
			CAV.camera_node.zoom += Vector2(0.05, 0.05) * CAV.camera_node.zoom
			CAV.camera_node.global_position -= d_mouse / CAV.camera_node.zoom / 20.0
		if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_WHEEL_DOWN:
			CAV.camera_node.zoom -= Vector2(0.05, 0.05) * CAV.camera_node.zoom
			CAV.camera_node.global_position += d_mouse / CAV.camera_node.zoom / 20.0

func _floating():
	floating_node.visible = !hide_floating_box.button_pressed

func _particles():
	Levels.vfx_particle_node.visible = enable_particles_box.button_pressed
	
func _shaders():
	Levels.vfx_shader_node.visible = enable_shaders_box.button_pressed
