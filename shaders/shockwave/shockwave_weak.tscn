[gd_scene load_steps=4 format=3 uid="uid://nqbcp1be7t8m"]

[ext_resource type="Script" path="res://shaders/shockwave/shockwave.gd" id="1_nqigk"]

[sub_resource type="Shader" id="Shader_cu8dq"]
code = "shader_type canvas_item;

uniform bool preview_atlas;
uniform vec2 position;
uniform float size;
uniform float feather : hint_range(0.0,0.8,0.01);
uniform float gap : hint_range(0.0,0.5,0.01);
uniform float force : hint_range(0.0,0.5,0.01);
uniform bool chromatic_abberation;
uniform float chromatic_offset : hint_range(0.0,0.5,0.01);
uniform sampler2D screen_texture : hint_screen_texture, repeat_disable, filter_nearest;

void fragment() {
	vec2 const_uv_size = vec2(1024.0,1024.0);
	// The total size of the rect shader is 1024 x 1024 but the only visible part is 1024x576
	// Meaning it has to be shifted up to 244px
	// The range of the rect shader becomes 224 up to 224 + 576
	// or 224 - 800
	
	// ^^ no longer needed since it's directly plugged into Camera2D
	//vec2 pos_shifted = vec2(position.x, position.y);
	//vec2 center_point = pos_shifted / const_uv_size;
	vec2 center_point = position / const_uv_size;
	// SHOCKWAVE
	vec2 scaled_uv = UV;//( SCREEN_UV - vec2(0.5,0) ) / ( vec2(screen_ratio, 1.0) ) + vec2(0.5, 0);
	float mask = ( 1.0 - 	smoothstep(size - feather, size, length(scaled_uv - center_point))) *
							smoothstep(size - feather - gap, size - gap, length(scaled_uv - center_point));
	// CHROMATIC ABBERATIONr
	vec2 display = normalize(scaled_uv - center_point) * force * mask;
	
	COLOR = texture(screen_texture, SCREEN_UV - display);
	
	if (chromatic_abberation){
		vec3 chromatic_effect;
		chromatic_effect.r = 1.0;
		chromatic_effect.g = 1.0 + chromatic_offset;
		chromatic_effect.b = 1.0 - chromatic_offset;
		
		COLOR.r = texture(screen_texture,SCREEN_UV - display * chromatic_effect.r).r;
		COLOR.g = texture(screen_texture,SCREEN_UV - display * chromatic_effect.g).g;
		COLOR.b = texture(screen_texture,SCREEN_UV - display * chromatic_effect.b).b;
	}
	
	// ATLAS
	if (preview_atlas){
		COLOR.rgb = vec3(mask);
	}
}

"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_027le"]
resource_local_to_scene = true
shader = SubResource("Shader_cu8dq")
shader_parameter/preview_atlas = true
shader_parameter/position = Vector2(512, 512)
shader_parameter/size = 0.2
shader_parameter/feather = 0.02
shader_parameter/gap = 0.0
shader_parameter/force = 0.05
shader_parameter/chromatic_abberation = true
shader_parameter/chromatic_offset = 0.15

[node name="Shockwave" type="BackBufferCopy"]
rect = Rect2(0, 0, 1024, 1024)
script = ExtResource("1_nqigk")
lifespan = 20.0
speed = 5.0
initial_size = 0.03

[node name="Shockwave" type="ColorRect" parent="."]
light_mask = 0
material = SubResource("ShaderMaterial_027le")
offset_right = 1024.0
offset_bottom = 1024.0
