extends BackBufferCopy

@export var lifespan: float
@export var atlas: bool = false
@export var speed: float
@export var initial_size: float
@onready var shockwave: ColorRect = $Shockwave

var vfx_shader_node: Node2D:
	get: return Levels.vfx_shader_node
var vfx_particle_node: Node2D:
	get: return Levels.vfx_particle_node

var tracker: Node2D = Node2D.new()
var initial_force: float
var shock_size: float
var force: float
var expanding: bool = false

func _ready():
	var viewport_size: float = get_tree().current_scene.get_viewport().size.x
	rect.size = Vector2(viewport_size,viewport_size)
	shock_size = initial_size
	initial_force = shockwave.material.get("shader_parameter/force")
	shockwave.material.set("shader_parameter/preview_atlas", atlas)
	force = 0.0
	
func _process(delta):
	var relative_position: Vector2 = tracker.global_position - Camera.instance.global_position
	var p: Vector2 = relative_position + Camera.const_viewport_resolution/2
		
	shockwave.material.set("shader_parameter/position", p)
	shockwave.material.set("shader_parameter/size", shock_size)
	shockwave.material.set("shader_parameter/force", force)
	
	shock_size += delta/(1/speed * 10)
	
	if !expanding:
		force += delta*2
		if force >= initial_force:
			expanding = true
			force = initial_force
			
	else:
		force -= delta/(lifespan)
		if force <= 0:
			set_process(false)
			tracker.queue_free()
			queue_free()

func spawn(_node: Object):
	tracker.global_position = _node.global_position
	vfx_particle_node.add_child(tracker)
	vfx_shader_node.add_child(self)
	
